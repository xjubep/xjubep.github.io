---
title: "[도커 교과서] 제8장 - 헬스 체크와 디펜더시 체크로 애플리케이션의 신뢰성 확보하기"
excerpt: "[도커 교과서] 제8장 - 헬스 체크와 디펜더시 체크로 애플리케이션의 신뢰성 확보하기"

categories:
  - Docker Textbook
tags:
  - Docker
last_modified_at: 2024-07-26T22:00KST
---

운영 환경에서는 Docker Swarm이나 Kubernetes 같은 컨테이너 플랫폼을 사용하여 애플리케이션을 실행합니다. 이러한 플랫폼은 애플리케이션이 비정상 상태일 때 스스로 회복할 수 있도록 도와줍니다. 플랫폼은 컨테이너에서 실행 중인 애플리케이션의 상태를 확인하고, 비정상일 경우 해당 컨테이너를 삭제하고 새 컨테이너로 대체합니다.

## 1. Docker 이미지에 헬스 체크 추가하기
Docker는 기본적으로 컨테이너 시작 시 프로세스가 실행 중인지 확인하지만, 애플리케이션이 정상적으로 동작하는지는 확인하지 못합니다. 이를 해결하기 위해 Docker 이미지에 헬스 체크 로직을 추가합니다.

### 예시: REST API 컨테이너
```shell
docker container run -d -p 8080:80 diamol/ch08-numbers-api

# API를 세 번 호출하면 무작위 숫자가 반환됩니다.
curl http://localhost:8080/rng
curl http://localhost:8080/rng
curl http://localhost:8080/rng

# 네 번째 호출부터 API가 실패합니다.
curl http://localhost:8080/rng
# {"status":500, "error":"Internal Server Error"}

# 컨테이너 상태를 확인합니다.
docker container ls
# 컨테이너는 여전히 'Up' 상태입니다.
```
Docker는 애플리케이션이 비정상 상태임을 알 수 없습니다. 이를 해결하기 위해 Docker 이미지에 헬스 체크 로직을 추가합니다.

### Dockerfile에 헬스 체크 추가
```dockerfile

FROM diamol/dotnet-aspnet

ENTRYPOINT ["dotnet", "/app/Numbers.Api.dll"]
HEALTHCHECK CMD curl --fail http://localhost/health

WORKDIR /app
COPY --from=builder /out/ .
```
`HEALTHCHECK` 명령어를 사용하여 애플리케이션의 상태를 주기적으로 확인할 수 있습니다. `--fail` 옵션을 통해 curl 명령이 실패할 경우, Docker는 해당 컨테이너를 비정상으로 간주합니다.

헬스 체크의 간격과 애플리케이션 상태를 이상으로 간주하는 누적 실패 횟수도 설정할 수 있습니다. 
기본값은 30초 간격으로, 연속 3회 이상 실패하면 애플리케이션이 이상 상태로 간주됩니다.

### 이미지 빌드 및 테스트
```shell
cd ./ch08/exercises/numbers
docker image build -t diamol/ch08-numbers-api:v2 -f ./numbers-api/Dockerfile.v2 .

docker container run -d -p 8081:80 diamol/ch08-numbers-api:v2

# 30초 정도 기다린 후 컨테이너 상태를 확인합니다.
docker container ls
# 상태가 'healthy'로 표시됩니다.

# API를 네 번 호출하여 상태를 확인합니다.
curl http://localhost:8081/rng
curl http://localhost:8081/rng
curl http://localhost:8081/rng
curl http://localhost:8081/rng

# 90초 후 컨테이너 상태를 확인합니다.
docker container ls
# 상태가 'unhealthy'로 표시됩니다.
```

## 2. 컨테이너의 의존 관계 체크
여러 컨테이너 간의 의존 관계를 관리하는 것은 중요합니다. 예를 들어, 무작위 숫자 API와 이를 사용하는 웹 애플리케이션이 분리된 컨테이너에서 실행되는 경우, 의존 관계를 만족하지 않으면 애플리케이션이 정상 동작하지 않습니다.

### 디펜던시 체크 추가
```dockerfile
FROM diamol/dotnet-aspnet

ENV RngApi:Url=http://numbers-api/rng

CMD curl --fail http://numbers-api/rng && \
    dotnet Numbers.Web.dll

WORKDIR /app
COPY --from=builder /out/ .
```
디펜던시 체크는 애플리케이션 시작 전에 필요한 요구 사항을 확인합니다. 예를 들어, 위의 Dockerfile에서는 API가 정상인지 확인한 후 애플리케이션을 실행합니다.

## 3. 커스텀 유틸리티로 헬스 체크 및 디펜던시 체크 구현
`curl`은 유용한 도구지만, 보안상의 이유로 실무에서는 사용하지 않는 것이 좋습니다. 대신 애플리케이션과 같은 언어로 작성된 커스텀 유틸리티를 사용하는 것이 좋습니다.

### 커스텀 유틸리티로 헬스 체크하기
```dockerfile
FROM diamol/dotnet-aspnet

ENTRYPOINT ["dotnet", "Numbers.Api.dll"]
HEALTHCHECK CMD ["dotnet", "Utilities.HttpCheck.dll", "-u", "http://localhost/health"]

WORKDIR /app
COPY --from=check-builder /out/ .
COPY --from=builder /out/ .
```

### 커스텀 유틸리티로 디펜던시 체크하기
`-t` 옵션은 요청 응답을 기다리는 제한 시간, `-c` 옵션은 설정 파일을 읽어 대상 URL을 지정합니다.
```dockerfile
FROM diamol/dotnet-aspnet

ENV RngApi:Url=http://numbers-api/rng

CMD dotnet Utilities.HttpCheck.dll -c RngApi:Url -t 900 && \
    dotnet Numbers.Web.dll

WORKDIR /app
COPY --from=check-builder /out/ .
COPY --from=builder /out/ .
```

## 4. Docker Compose에서 헬스 체크와 디펜던시 체크 정의하기
### 무작위 숫자 API에 대한 도커 컴포즈 설정
아래는 무작위 숫자 API를 위한 도커 컴포즈 파일입니다. 이 스크립트는 v3 버전의 컨테이너를 사용하고, 헬스 체크 및 커스텀 테스트 유틸리티가 포함되어 있습니다
```yaml
services:
  numbers-api:
    image: diamol/ch08-numbers-api:v3
    ports:
      - "8087:80"
    healthcheck:
      interval: 5s
      timeout: 1s
      retries: 2
      start_period: 5s
    networks:
      - app-net
```
도커 컴포즈 파일에서 헬스 체크 옵션을 더 세밀하게 설정할 수 있습니다:

- `interval`: 헬스 체크 간격
- `timeout`: 응답 제한 시간
- `retries`: 실패로 간주하기까지의 연속 실패 횟수
- `start_period`: 첫 헬스 체크 전 대기 시간

이미지에 헬스 체크가 정의되지 않았다면 컴포즈 파일에서 직접 설정할 수 있습니다.

### 웹 애플리케이션에 대한 헬스 체크 정의
다음은 웹 애플리케이션 컨테이너에 대한 도커 컴포즈 파일입니다. 여기서 헬스 체크와 디펜던시 체크가 모두 정의되어 있습니다.
```yaml
services:
  numbers-web:
    image: diamol/ch08-numbers-web:v3
    restart: on-failure
    environment:
      - RngApi__Url=http://numbers-api/rng
    ports:
      - "8088:80"
    healthcheck:
      test: ["CMD", "dotnet", "Utilities.HttpCheck.dll", "-t", "150"]
      interval: 5s
      timeout: 1s
      retries: 2
      start_period: 10s
    networks:
      - app-net
```
이 설정은 다음과 같은 기능을 제공합니다:

- 헬스 체크를 통해 컨테이너 상태를 지속적으로 확인
- 디펜던시 체크로 필요한 서비스가 준비되었는지 확인
- `restart: on-failure` 설정으로 컨테이너가 예기치 않게 종료될 경우 자동 재시작

### 디펜던시 체크와 `depends_on` 설정
도커 컴포즈 파일에는 `depends_on` 설정이 없으므로 컨테이너 실행 순서가 보장되지 않습니다. 이는 API 컨테이너가 준비되기 전에 웹 컨테이너가 실행될 수 있다는 의미입니다. 하지만 `restart: on-failure` 설정 덕분에 웹 컨테이너는 API 컨테이너가 준비될 때까지 재시작을 시도하게 됩니다.

**`depends_on` 설정을 사용하지 않는 이유는 도커 컴포즈의 디펜던시 체크가 단일 서버 내에서만 가능하기 때문입니다. 이를 통해 전체 애플리케이션이 올바르게 실행될 수 있습니다.**

### 5. 헬스 체크와 디펜던시 체크의 중요성
헬스 체크와 디펜던시 체크를 통해 애플리케이션의 복원력을 높일 수 있습니다. 컨테이너 플랫폼은 의존 관계를 자동으로 관리하고, 애플리케이션의 상태를 지속적으로 모니터링하여 문제가 발생하면 즉시 대응할 수 있습니다.

헬스 체크는 시스템에 부하를 주지 않도록 주의해야 하며, 디펜던시 체크는 실행 시점에만 수행되므로 중요한 요구 사항을 빠짐없이 점검해야 합니다.

이러한 체크들을 통해 복잡한 분산 애플리케이션의 안정성을 높일 수 있습니다.


## 5. 헬스 체크와 디펜던시 체크로 복원력 있는 애플리케이션을 만들 수 있는 이유
### 복잡한 의존 관계 해결의 어려움
애플리케이션의 구성 요소들 간에 복잡한 의존 관계가 있을 때, 이를 순서대로 시작하도록 모델링하고 싶을 수 있습니다. 하지만 이는 효율적인 방법이 아닙니다.

### 단일 서버 vs 다중 서버 환경
단일 서버에서는 도커 컴포즈를 이용해 웹 컨테이너보다 API 컨테이너를 먼저 실행하도록 지시할 수 있습니다. 그러나 여러 서버에서 쿠버네티스를 운영하는 경우에는 상황이 복잡해집니다. 예를 들어, 10대의 서버에서 20개의 API 컨테이너와 50개의 웹 애플리케이션 컨테이너를 실행한다고 가정해보겠습니다.

- **API 컨테이너 20개 중 19개가 실행되고 1개가 늦어질 경우**: 웹 애플리케이션 컨테이너 50개는 실행에 문제가 없습니다. 그러나 API 컨테이너 1개가 부족하다고 전체 애플리케이션이 중단되면 비효율적입니다.

### 헬스 체크와 디펜던시 체크의 역할
헬스 체크와 디펜던시 체크를 사용하면 초기 실행 순서를 보장할 필요가 없습니다. 가능한 한 빨리 컨테이너를 실행하고, 의존 관계가 충족되지 않으면 컨테이너를 재실행하거나 다른 컨테이너로 교체하면 됩니다.

예를 들어, 애플리케이션에 메모리 누수가 발생하더라도 플랫폼이 해당 컨테이너를 새로운 컨테이너로 대체하면 문제를 해결할 수 있습니다.

### 주의 사항
- **헬스 체크**: 주기적으로 실행되므로 시스템에 과부하를 주지 않도록 주의해야 합니다. 자원을 적게 사용하면서도 애플리케이션이 정상 동작 중인지를 검증할 수 있는 핵심적인 부분을 테스트해야 합니다.
- **디펜던시 체크**: 애플리케이션 시작 시에만 실행되므로 리소스 사용에 큰 걱정은 없습니다. 그러나 테스트 대상이 정확하고 빠짐없이 포함되어야 합니다.

헬스 체크와 디펜던시 체크를 도입하면 애플리케이션의 복원력을 높이고, 보다 유연하고 안정적인 서비스를 제공할 수 있습니다.