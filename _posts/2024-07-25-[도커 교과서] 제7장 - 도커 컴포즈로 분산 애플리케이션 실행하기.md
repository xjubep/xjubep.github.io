---
title: "[도커 교과서] 제7장 - 도커 컴포즈로 분산 애플리케이션 실행하기"
excerpt: "[도커 교과서] 제7장 - 도커 컴포즈로 분산 애플리케이션 실행하기"

categories:
  - Docker Textbook
tags:
  - Docker
last_modified_at: 2024-07-25T22:00KST
---
## 1. Docker Compose 파일의 구조
도커 컴포즈는 여러 컨테이너로 구성된 애플리케이션의 구조를 정의하는 데 사용됩니다. Dockerfile이 하나의 컨테이너를 정의하는 데 사용된다면, 도커 컴포즈 파일은 여러 컨테이너를 함께 정의합니다.

도커 컴포즈 파일은 YAML 형식으로 작성되며, 애플리케이션이 실행 중일 때의 상태와 `docker container run` 명령의 옵션들을 모아둔 파일입니다.

다음은 도커 컴포즈 파일의 예입니다:
```yaml
version: '3.7'

services:
  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - "8020:80"
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```
이 예제는 간단한 애플리케이션을 나타내며, 도커 네트워크 `nat`에 연결된 `todo-web` 컨테이너를 정의합니다.

도커 컴포즈 파일의 주요 구성 요소는 다음과 같습니다:

- `version`: 도커 컴포즈 파일의 버전을 지정합니다.
- `services`: 애플리케이션을 구성하는 모든 컨테이너를 정의합니다.
- `networks`: 컨테이너들이 연결될 도커 네트워크를 정의합니다.

위 예제의 도커 컴포즈 파일은 다음 명령과 동일한 역할을 합니다:
```shell
docker container run -p 8020:80 --name todo-web --network nat diamol/ch06-todo-list
```

도커 컴포즈로 애플리케이션을 시작하려면, 다음 명령을 실행합니다:
```shell
docker network create nat
cd ./ch07/exercises/todo-list
docker compose up
```
`docker compose up` 명령은 현재 디렉터리의 `docker-compose.yml` 파일을 읽고, 정의된 애플리케이션을 실행합니다

## 2. 도커 컴포즈를 사용해 여러 컨테이너로 구성된 애플리케이션 실행하기
이제 도커 컴포즈를 사용해 여러 컨테이너로 구성된 애플리케이션을 실행해보겠습니다. 다음은 이미지 갤러리를 구성하는 컴포즈 파일입니다:
```yaml
version: '3.7'

services:

  accesslog:
    image: diamol/ch04-access-log
    networks:
      - app-net

  iotd:
    image: diamol/ch04-image-of-the-day
    ports:
      - "80"
    networks:
      - app-net

  image-gallery:
    image: diamol/ch04-image-gallery
    ports:
      - "8010:80"
    depends_on:
      - accesslog
      - iotd
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```
이 파일은 세 개의 서비스를 정의합니다:

* `accesslog`: 로깅 서비스
* `iotd`: REST API 서비스
* `image-gallery`: 웹 인터페이스 서비스

도커 컴포즈를 사용해 애플리케이션을 실행해보겠습니다:
```shell
cd ./ch07/exercises/image-of-the-day
docker compose up --detach
````
이 명령을 실행하면 세 개의 서비스가 백그라운드에서 실행됩니다. 웹 브라우저에서 http://localhost:8010 으로 접속해 결과를 확인할 수 있습니다.

이제 iotd 서비스의 컨테이너 수를 늘려보겠습니다:
```shell
docker compose up -d --scale iotd=3
```
이 명령을 실행하면 `iotd` 서비스가 세 개의 컨테이너로 확장되어, 부하를 분산 처리할 수 있습니다.

도커 컴포즈로 실행한 컨테이너도 도커 명령어로 관리할 수 있습니다:
```shell
docker compose stop
docker compose start
docker container ls
```
도커 컴포즈는 클라이언트 측에서 동작하는 도구로, 컴포즈 파일의 내용에 따라 도커 API로 지시를 보냅니다. 
도커 엔진은 여러 컨테이너를 실행하지만, 이들이 하나의 애플리케이션으로 동작하는지 여부는 알지 못합니다.

## 3. 도커 컨테이너 간의 통신
컨테이너는 도커 엔진으로부터 가상 IP 주소를 받지만, 컨테이너가 교체되면 IP 주소도 변경됩니다. 이를 해결하기 위해 도커는 DNS를 이용한 서비스 디스커버리 기능을 제공합니다.

다음 명령을 실행해 봅시다:
```
docker compose up -d --scale iotd=3
docker container exec -it image-of-the-day-image-gallery-1 sh
nslookup accesslog
exit
```
`nslookup` 명령은 도메인을 DNS에서 조회하고 그 결과를 출력합니다. 
도커 네트워크에 연결된 모든 컨테이너는 이 네트워크를 통해 통신할 수 있습니다. 
도커 컴포즈는 로드 밸런싱을 통해 여러 컨테이너에 부하를 분산시킬 수 있습니다.

## 4. 도커 컴포즈로 애플리케이션 설정값 지정하기
소규모 프로젝트에서는 애플리케이션을 단일 컨테이너로 실행하고 데이터를 SQLite에 저장할 수 있습니다. 
하지만 규모가 커지면 별도의 데이터베이스를 사용하는 것이 좋습니다. 
여기서는 PostgreSQL 데이터베이스를 사용해보겠습니다.

다음은 PostgreSQL을 사용하는 컴포즈 파일 예제입니다:  

```shell
services:

  todo-db:
    image: diamol/postgres:11.5
    ports:
      - "5433:5432"
    networks:
      - app-net
  
  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - "8020:80"
    environment:
      - Database:Provider=Postgres
    depends_on:
      - todo-db
    networks:
      - app-net
    secrets:
      - source: postgres-connection
        target: /app/config/secrets.json

secrets:
  postgres-connection:
    file: ./config/secrets.json
```
* `environment`: 컨테이너 내 환경 변수를 정의합니다.
* `secrets`: 민감한 정보를 파일로 기록합니다.

이 설정을 통해 다양한 환경에서 동일한 이미지를 사용할 수 있습니다.

## 5. 도커 컴포즈의 한계
도커 컴포즈는 여러 컨테이너를 정의하고 관리하는 데 유용하지만, 도커 스웜이나 쿠버네티스와 같은 완전한 컨테이너 오케스트레이션 플랫폼은 아닙니다. 
컴포즈는 단일 컴퓨터에서 애플리케이션을 실행하는 데 적합하며, 컨테이너가 중단되면 자동으로 복구되지 않습니다.

그러나 도커 컴포즈는 개발 환경에서 운영 환경으로 이행하는 과정에서 유용한 도구입니다. 
개발, CI, 테스트 환경에서 애플리케이션을 실행하고 테스트하는 데 적합합니다. 
운영 환경에서는 도커 스웜이나 쿠버네티스를 사용하는 것이 좋지만, 컴포즈 파일 포맷은 여전히 유용합니다.

## 6. 연습 문제
이번 연습 문제는 to-do 애플리케이션을 테스트 환경에서 더 신뢰성 있게 실행하는 도커 컴포즈 파일을 작성하는 것입니다.

### 요구 사항:
1. 호스트 컴퓨터가 재부팅되거나 도커 엔진이 재시작되면 애플리케이션 컨테이너도 재시작되도록 설정합니다.
2. 데이터베이스 컨테이너는 바인드 마운트에 파일을 저장해 데이터가 유지되도록 합니다.

### 예제 파일:
**docker-compose-dev.yml**
```yaml
version: "3.7"

services:
  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - "8020:80"
    environment:
      - Database:Provider=Sqlite
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```

**docker-compose-test.yml**
```yaml
version: "3.7"

services:
  todo-db:
    image: diamol/postgres:11.5
    restart: unless-stopped
    environment:
      - PGDATA=/var/lib/postgresql/data
    volumes:
      - type: bind
        source: /data/postgres
        target: /var/lib/postgresql/data
    networks:
      - app-net

  todo-web:
    image: diamol/ch06-todo-list
    restart: unless-stopped
    ports:
      - "8050:80"
    environment:
      - Database:Provider=Postgres
    depends_on:
      - todo-db
    secrets:
      - source: postgres-connection
        target: /app/config/secrets.json

secrets:
  postgres-connection:
    file: postgres-connection.json

networks:
  app-net:
    external:
      name: nat
```
